{% extends 'base.html' %}
{% block content %}
<div class="row justify-content-center">
  <div class="col-lg-6">
    <div class="card card-glass p-4">
      <h3 class="mb-3">Create secure group</h3>
      <a href="{{ url_for('chat.chat') }}" class="btn btn-outline-light btn-sm mb-3"><i class="fa-solid fa-arrow-left"></i> Back to chat</a>
      <form method="post" novalidate>
        {{ form.hidden_tag() }}
        {% if form.errors %}
        <div class="alert alert-danger">
          {% for field, errors in form.errors.items() %}
            {% for error in errors %}
              <div>{{ error }}</div>
            {% endfor %}
          {% endfor %}
        </div>
        {% endif %}
        <div class="mb-3">{{ form.name.label(class='form-label') }}{{ form.name(class='form-control') }}</div>
        <div class="mb-3">
          {{ form.secret.label(class='form-label mb-1') }}
          <div class="input-group">
            {{ form.secret(class='form-control', autocomplete='off') }}
            <button type="button" class="btn btn-outline-light" id="gen-secret"><i class="fa-solid fa-wand-magic-sparkles"></i></button>
            <button type="button" class="btn btn-outline-light" id="copy-secret"><i class="fa-solid fa-copy"></i></button>
          </div>
          <small class="text-muted">Use a strong secret (16+ characters recommended). This shared secret never leaves clientsâ€”distribute out-of-band.</small>
        </div>
        <button class="btn btn-soft w-100" type="submit">{{ form.submit.label.text }}</button>
      </form>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
  (() => {
    const btn = document.getElementById('gen-secret');
    const input = document.getElementById('{{ form.secret.id }}');
    const copyBtn = document.getElementById('copy-secret');
    function randomSecret(len = 24) {
      const chars = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*()-_=+';
      let out = '';
      const arr = crypto.getRandomValues(new Uint32Array(len));
      for (let i = 0; i < len; i++) {
        out += chars[arr[i] % chars.length];
      }
      return out;
    }
    if (btn && input) {
      btn.addEventListener('click', () => {
        input.value = randomSecret();
      });
    }
    async function copySecretValue(value) {
      if (!value) return false;
      try {
        if (navigator?.clipboard?.writeText) {
          await navigator.clipboard.writeText(value);
          return true;
        }
      } catch (e) {
        // fall back
      }
      try {
        const ta = document.createElement('textarea');
        ta.value = value;
        ta.setAttribute('readonly', '');
        ta.style.position = 'fixed';
        ta.style.top = '-1000px';
        ta.setAttribute('aria-hidden', 'true');
        document.body.appendChild(ta);
        ta.select();
        ta.setSelectionRange(0, ta.value.length);
        const ok = document.execCommand('copy');
        document.body.removeChild(ta);
        return ok;
      } catch (e) {
        return false;
      }
    }
    if (copyBtn && input) {
      copyBtn.addEventListener('click', async () => {
        const ok = await copySecretValue(input.value || '');
        try {
          window.showToast?.(ok ? 'success' : 'error', ok ? 'Copied' : 'Copy failed', ok ? 'Secret copied to clipboard.' : 'Clipboard is blocked in this browser.');
        } catch (e) {
          // ignore toast errors
        }
        try {
          copyBtn.textContent = 'Copied';
          setTimeout(() => { copyBtn.innerHTML = '<i class="fa-solid fa-copy"></i> Copy'; }, 1200);
        } catch (e) {
          copyBtn.textContent = 'Failed';
          setTimeout(() => { copyBtn.innerHTML = '<i class="fa-solid fa-copy"></i> Copy'; }, 1200);
        }
      });
    }
  })();
</script>
{% endblock %}
