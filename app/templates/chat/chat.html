{% extends 'base.html' %}
{% block content %}
<div class="chat-shell" data-user-id="{{ current_user.id }}" data-username="{{ current_user.username }}" data-max-bytes="{{ config.MAX_CONTENT_LENGTH }}" data-user-tz="{{ current_user.timezone or 'UTC' }}" data-ai-enabled="{{ 'true' if config.AI_ENABLED else 'false' }}" data-allow-delete="{{ 'true' if config.ALLOW_MESSAGE_DELETE else 'false' }}" data-default-avatar="{{ default_avatar }}">
  <div class="collapse d-lg-block desktop-spaces" id="groupSidebar">
    <div class="card card-glass p-3 sidebar-card mb-3">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="mb-0"><i class="fa-solid fa-layer-group me-2"></i>{{ _('Spaces') }}</h5>
        <div class="btn-group">
          <a class="btn btn-sm btn-soft" href="{{ url_for('chat.create_group') }}" title="{{ _('Create group') }}"><i class="fa-solid fa-plus"></i></a>
        </div>
      </div>
        <div class="contact-list list-group list-group-flush" id="group-list">
          {% for g in groups %}
            <div class="list-group-item d-flex justify-content-between align-items-center bg-transparent text-start text-light border-0">
              <button class="btn btn-link text-start text-light flex-grow-1 position-relative" data-group-id="{{ g.id }}" data-group-name="{{ g.name }}">
                <i class="fa-solid fa-hashtag me-2"></i><span class="group-name">{{ g.name }}</span>
                <span class="secret-dot ms-2" data-secret-dot="{{ g.id }}"></span>
              </button>
              {% if g.created_by == current_user.id %}
              <button class="btn btn-outline-danger btn-sm delete-group" data-delete-group="{{ g.id }}" data-group-name="{{ g.name }}" title="Delete group">
                <i class="fa-solid fa-trash"></i>
              </button>
              {% endif %}
            </div>
          {% else %}
            <p class="text-muted">{{ _('No groups yet. Create or join using a secret hash.') }}</p>
          {% endfor %}
      </div>
      <div class="mt-3" id="join-inline">
        <label class="form-label">{{ _('Join via secret hash') }}</label>
        <div class="input-group">
          <input type="password" class="form-control" id="join-secret" placeholder="{{ _('Paste shared secret') }}" autocomplete="off">
          <button class="btn btn-outline-light" type="button" id="join-secret-toggle" aria-label="{{ _('Show secret') }}">
            <i class="fa-solid fa-eye"></i>
          </button>
        </div>
        <input type="text" class="form-control mt-2" id="join-group-name" placeholder="{{ _('Group name') }}">
        <button class="btn btn-outline-light w-100 mt-2" id="join-btn">{{ _('Join securely') }}</button>
      </div>
      <hr class="text-secondary">
      <div>
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h6 class="mb-0"><i class="fa-solid fa-user-group me-2"></i>{{ _('Users') }}</h6>
        </div>
        <div class="contact-list list-group list-group-flush" id="user-list"></div>
      </div>
    </div>

    <div class="card card-glass p-3 sidebar-card mb-3">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h6 class="mb-0"><i class="fa-solid fa-star me-2 text-success"></i>{{ _('Favorites') }}</h6>
      </div>
      <div class="contact-list list-group list-group-flush" id="favorite-list">
        <div class="text-muted small">{{ _('No favorites yet.') }}</div>
      </div>
    </div>

    <div class="card card-glass p-3 sidebar-card">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h6 class="mb-0"><i class="fa-solid fa-calendar-check me-2"></i>{{ _('Scheduled chats') }}</h6>
        <button class="btn btn-sm btn-soft" type="button" data-bs-toggle="modal" data-bs-target="#scheduleModal"><i class="fa-solid fa-plus"></i></button>
      </div>
      <div class="contact-list list-group list-group-flush" id="scheduled-list" data-empty-text="{{ _('No scheduled chats yet.') }}">
        <div class="text-muted small">{{ _('No scheduled chats yet.') }}</div>
      </div>
    </div>
  </div>

  <div class="card card-glass p-3 position-relative" id="chat-panel">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <div class="d-flex align-items-center gap-2">
        <button class="btn btn-outline-light" data-bs-toggle="collapse" data-bs-target="#groupSidebar">
          <i class="fa-solid fa-bars"></i>
        </button>
        <div>
          <h5 class="mb-0" id="chat-title">{{ _('Select a group') }}</h5>
          <small class="text-muted" id="presence-label"><i class="fa-solid fa-signal"></i> {{ _('waiting') }}</small>
        </div>
      </div>
      <div class="d-flex gap-2 align-items-center">
        <span class="badge bg-dark"><i class="fa-solid fa-shield-halved"></i> AES-GCM</span>
        <button class="btn btn-sm btn-outline-light position-relative" id="info-indicator" title="{{ _('No new notifications') }}">
          <i class="fa-solid fa-circle-info"></i>
          <span class="notification-dot d-none" id="info-dot"></span>
          <span class="notification-count d-none" id="info-count"></span>
        </button>
        <button class="btn btn-sm btn-outline-light" id="theme-toggle" data-theme-toggle><i class="fa-solid fa-circle-half-stroke"></i></button>
      </div>
    </div>
    <div class="message-list" id="message-list"></div>
    <div class="message-loading d-none" id="message-loading">
      <div class="spinner-border text-accent" role="status" aria-label="{{ _('Loading messages') }}"></div>
    </div>
    <button type="button" class="scroll-top-btn" id="scroll-top-btn" aria-label="{{ _('Scroll to top') }}" aria-hidden="true">
      <i class="fa-solid fa-arrow-up"></i>
    </button>
    <div class="card card-glass input-card mt-3 p-2 position-relative sticky-input d-flex flex-column">
      <div class="d-flex gap-2 align-items-center flex-wrap flex-md-nowrap input-row">
        <input type="file" id="file-input" class="d-none" accept="image/*,video/*,audio/*">
        <textarea class="form-control flex-grow-1" rows="2" id="message-input" placeholder="{{ _('Type an encrypted whisper...') }}" maxlength="5000"></textarea>
        <div class="d-flex align-items-center gap-2 flex-grow-1 flex-md-grow-0">
          <button class="btn btn-outline-light btn-sm flex-fill" id="attach-btn" title="{{ _('Attach') }}"><i class="fa-solid fa-paperclip"></i></button>
          <button class="btn btn-outline-light btn-sm flex-fill" id="emoji-btn" title="{{ _('Insert emoji') }}"><i class="fa-regular fa-face-smile"></i></button>
          <button class="btn btn-outline-light btn-sm flex-fill" id="record-btn" title="{{ _('Record voice note') }}"><i class="fa-solid fa-microphone"></i></button>
          <button class="btn btn-outline-light btn-sm flex-fill" id="refresh-btn" title="{{ _('Reload messages') }}"><i class="fa-solid fa-rotate-right"></i></button>
          <div id="upload-spinner" class="spinner-border spinner-border-sm text-info d-none" role="status"></div>
          <button class="btn btn-soft send-btn flex-fill" id="send-btn"><i class="fa-solid fa-paper-plane"></i></button>
        </div>
      </div>
      <div class="text-danger small mt-2 d-none" id="recording-indicator">{{ _('Recordingâ€¦ click mic to stop.') }}</div>
      <div class="emoji-picker d-none" id="emoji-picker" aria-label="Emoji picker"></div>
      <div class="d-flex justify-content-between align-items-center mt-2 text-muted small">
        <span><i class="fa-solid fa-lock"></i> {{ _('Client-side cryptography!') }}</span>
        <span id="typing-indicator" class="text-info d-none"><i class="fa-solid fa-pen"></i> {{ _('typing...') }}</span>
      </div>
    </div>
  </div>
</div>

<!-- Schedule modal -->
<div class="modal fade" id="scheduleModal" tabindex="-1" aria-labelledby="scheduleModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content bg-dark text-light">
      <div class="modal-header border-0">
        <h5 class="modal-title" id="scheduleModalLabel">{{ _('Schedule chat') }}</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label class="form-label">{{ _('Name') }}</label>
          <input type="text" class="form-control" id="sched-name" maxlength="128" placeholder="{{ _('Team catch-up') }}">
        </div>
        <div class="mb-3">
          <label class="form-label">{{ _('Start time') }}</label>
          <input type="datetime-local" class="form-control" id="sched-start">
        </div>
        <div class="mb-3">
          <label class="form-label">{{ _('End time') }}</label>
          <input type="datetime-local" class="form-control" id="sched-end">
        </div>
        <div class="form-check mb-3">
          <input class="form-check-input" type="checkbox" id="sched-never">
          <label class="form-check-label" for="sched-never">{{ _('Never expire') }}</label>
        </div>
      </div>
      <div class="modal-footer border-0">
        <button type="button" class="btn btn-outline-light" data-bs-dismiss="modal">{{ _('Cancel') }}</button>
        <button type="button" class="btn btn-soft" id="sched-save">{{ _('Create') }}</button>
      </div>
    </div>
  </div>
</div>

<!-- Shared secret modal -->
<div class="modal fade" id="secretModal" tabindex="-1" aria-labelledby="secretModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content bg-dark text-light">
      <div class="modal-header border-0">
        <h5 class="modal-title" id="secretModalLabel">{{ _('Enter shared secret') }}</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p class="text-muted small mb-2">{{ _('This secret never leaves your device. It is required to decrypt and send messages in this group.') }}</p>
        <input type="hidden" id="secret-group-id">
        <input type="password" class="form-control" id="secret-input" placeholder="{{ _('Shared secret') }}" autocomplete="off">
        <div class="text-danger small mt-2 d-none" id="secret-error">{{ _('Secret is required.') }}</div>
        <div class="form-check mt-3">
          <input class="form-check-input" type="checkbox" value="" id="remember-secret">
          <label class="form-check-label" for="remember-secret">
            {{ _('Remember for this session') }}
          </label>
        </div>
        <div class="form-check mt-2">
          <input class="form-check-input" type="checkbox" value="" id="remember-secret-permanent">
          <label class="form-check-label text-warning" for="remember-secret-permanent">
            {{ _('Save secret in this browser (unsafe)') }}
          </label>
        </div>
      </div>
      <div class="modal-footer border-0">
        <button type="button" class="btn btn-outline-light" data-bs-dismiss="modal">{{ _('Cancel') }}</button>
        <button type="button" class="btn btn-soft" id="secret-save">{{ _('Save secret') }}</button>
      </div>
    </div>
  </div>
</div>

<!-- Delete group modal -->
<div class="modal fade" id="deleteGroupModal" tabindex="-1" aria-labelledby="deleteGroupModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content bg-dark text-light">
      <div class="modal-header border-0">
        <h5 class="modal-title" id="deleteGroupModalLabel">{{ _('Delete group') }}</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p class="mb-2">{{ _('This will delete the group and all encrypted data for') }} <span id="delete-group-name" class="fw-semibold"></span>.</p>
        <p class="text-danger small mb-0">{{ _('Action is irreversible.') }}</p>
      </div>
      <div class="modal-footer border-0">
        <button type="button" class="btn btn-outline-light" data-bs-dismiss="modal">{{ _('Cancel') }}</button>
        <button type="button" class="btn btn-danger" id="confirm-delete-group">{{ _('Delete') }}</button>
      </div>
    </div>
  </div>
</div>

<!-- Delete message modal -->
<div class="modal fade" id="deleteMessageModal" tabindex="-1" aria-labelledby="deleteMessageModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content bg-dark text-light">
      <div class="modal-header border-0">
        <h5 class="modal-title" id="deleteMessageModalLabel">{{ _('Delete message') }}</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p class="mb-0">{{ _('Are you sure you want to delete this message?') }}</p>
      </div>
      <div class="modal-footer border-0">
        <button type="button" class="btn btn-outline-light" data-bs-dismiss="modal">{{ _('Cancel') }}</button>
        <button type="button" class="btn btn-danger" id="confirm-delete-message">{{ _('Delete') }}</button>
      </div>
    </div>
  </div>
</div>

<!-- DM modal -->
<div class="modal fade" id="dmModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content bg-dark text-light">
      <div class="modal-header border-0">
        <h5 class="modal-title">{{ _('Start private chat') }}</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p class="text-muted">{{ _('Enter a shared secret for this private conversation. It will be used to derive your E2EE key.') }}</p>
        <input type="hidden" id="dm-user-id">
        <div class="mb-3">
          <label class="form-label">{{ _('Secret') }}</label>
          <div class="input-group">
            <input type="password" class="form-control" id="dm-secret" autocomplete="off" minlength="12">
            <button class="btn btn-outline-light" type="button" id="dm-secret-toggle" aria-label="{{ _('Show secret') }}"><i class="fa-solid fa-eye"></i></button>
            <button class="btn btn-outline-light" type="button" id="dm-secret-gen" aria-label="{{ _('Generate secret') }}"><i class="fa-solid fa-wand-magic-sparkles"></i></button>
            <button class="btn btn-outline-light" type="button" id="dm-secret-copy" aria-label="{{ _('Copy secret') }}"><i class="fa-solid fa-copy"></i></button>
          </div>
          <div class="form-text text-muted">{{ _('Minimum 12 characters.') }}</div>
        </div>
      </div>
      <div class="modal-footer border-0">
        <button type="button" class="btn btn-outline-light" data-bs-dismiss="modal">{{ _('Cancel') }}</button>
        <button type="button" class="btn btn-soft" id="dm-start-btn">{{ _('Start') }}</button>
      </div>
    </div>
  </div>
</div>

<!-- Media modal -->
<div class="modal fade" id="mediaModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content bg-dark text-light position-relative">
      <div class="modal-header border-0 pb-0">
        <h5 class="modal-title">Media preview</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body text-center" id="mediaModalBody"></div>
    </div>
  </div>
</div>

<!-- Info modal -->
<div class="modal fade" id="infoModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content bg-dark text-light">
      <div class="modal-header border-0">
        <h5 class="modal-title" id="infoModalTitle">Notice</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="infoModalBody"></div>
      <div class="modal-footer border-0">
        <button type="button" class="btn btn-soft" data-bs-dismiss="modal">OK</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/chat.js', v=config.APP_VERSION) }}"></script>
{% include 'modals/scheduled_delete.html' %}
<script>
  (() => {
    const sidebar = document.getElementById('groupSidebar');
    if (!sidebar || typeof bootstrap === 'undefined') return;
    let userToggled = false;
    const toggleBtns = document.querySelectorAll('[data-bs-target=\"#groupSidebar\"]');
    toggleBtns.forEach((btn) => {
      btn.addEventListener('click', () => { userToggled = true; });
    });
    const syncSidebar = () => {
      const isDesktop = window.matchMedia('(min-width: 992px)').matches;
      const inst = bootstrap.Collapse.getOrCreateInstance(sidebar, { toggle: false });
      if (isDesktop && !userToggled) {
        inst.show();
      }
      if (!isDesktop) {
        inst.hide();
        userToggled = false;
      }
    };
    window.addEventListener('resize', syncSidebar);
    syncSidebar();
  })();
</script>
{% endblock %}
