{% extends 'base.html' %}
{% block content %}
<div class="chat-shell" data-user-id="{{ current_user.id }}" data-username="{{ current_user.username }}" data-max-bytes="{{ config.MAX_CONTENT_LENGTH }}" data-user-tz="{{ current_user.timezone or 'UTC' }}" data-ai-enabled="{{ 'true' if config.AI_ENABLED else 'false' }}" data-allow-delete="{{ 'true' if config.ALLOW_MESSAGE_DELETE else 'false' }}" data-default-avatar="{{ default_avatar }}">
<div class="desktop-spaces sidebar-column" id="groupSidebar">
    <div class="card card-glass p-3 sidebar-card mb-3">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="mb-0"><i class="fa-solid fa-layer-group me-2"></i>{{ _('Whisper Rooms') }}</h5>
        <div class="btn-group">
          <button class="btn btn-sm btn-soft" type="button" title="{{ _('Create group') }}" data-bs-toggle="modal" data-bs-target="#createGroupModal">
            <i class="fa-solid fa-plus"></i>
          </button>
        </div>
      </div>
        <div class="contact-list list-group list-group-flush" id="group-list">
          {% for g in groups %}
            <div class="list-group-item d-flex justify-content-between align-items-center bg-transparent text-start text-light border-0">
              <button class="btn btn-link text-start text-light flex-grow-1 position-relative" data-group-id="{{ g.id }}" data-group-name="{{ g.name }}">
                <i class="fa-solid fa-hashtag me-2"></i><span class="group-name">{{ g.name }}</span>
                <span class="secret-dot ms-2" data-secret-dot="{{ g.id }}"></span>
              </button>
              {% if g.created_by == current_user.id %}
              <button class="btn btn-outline-danger btn-sm delete-group" data-delete-group="{{ g.id }}" data-group-name="{{ g.name }}" title="Delete group">
                <i class="fa-solid fa-trash"></i>
              </button>
              {% endif %}
            </div>
          {% else %}
            <p class="text-muted">{{ _('No groups yet. Create or join using a secret hash.') }}</p>
          {% endfor %}
      </div>
      <div class="mt-3" id="join-inline">
        <label class="form-label">{{ _('Join via secret hash') }}</label>
        <div class="input-group">
          <input type="password" class="form-control" id="join-secret" placeholder="{{ _('Paste shared secret') }}" autocomplete="off">
          <button class="btn btn-outline-light" type="button" id="join-secret-toggle" aria-label="{{ _('Show secret') }}">
            <i class="fa-solid fa-eye"></i>
          </button>
        </div>
        <input type="text" class="form-control mt-2" id="join-group-name" placeholder="{{ _('Group name') }}">
        <button class="btn btn-outline-light w-100 mt-2" id="join-btn">{{ _('Join securely') }}</button>
        <button type="button" class="btn btn-info w-100 mt-2 d-lg-none" id="scan-qr-btn">
          <i class="fa-solid fa-qrcode me-1"></i>{{ _('Scan QR code') }}
        </button>
        <p class="text-muted small mt-1 d-lg-none">{{ _('Point your camera at the QR to join instantly.') }}</p>
        <div
          id="qr-scan-text"
          class="d-none"
          data-camera-missing="{{ _('Scanning requires a device camera.') }}"
          data-camera-denied="{{ _('Allow camera access to continue.') }}"
          data-invalid="{{ _('This QR code does not contain a valid invitation.') }}"
          data-join-failed="{{ _('Unable to join the space from this QR code.') }}"
          data-library-missing="{{ _('Unable to load the QR decoder.') }}"
        ></div>
        <div id="qr-join-config" data-join-url="{{ url_for('chat.join_group') }}"></div>
      </div>
      <hr class="text-secondary">
      <div>
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h6 class="mb-0"><i class="fa-solid fa-user-group me-2"></i>{{ _('Users') }}</h6>
        </div>
        <div class="contact-list list-group list-group-flush" id="user-list"></div>
      </div>
    </div>

    <div class="card card-glass p-3 sidebar-card mb-3">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h6 class="mb-0 favorites-title"><i class="fa-solid fa-star me-2"></i>{{ _('Favorites') }}</h6>
      </div>
      <div class="contact-list list-group list-group-flush" id="favorite-list">
        <div class="text-muted small">{{ _('No favorites yet.') }}</div>
      </div>
    </div>

    <div class="card card-glass p-3 sidebar-card">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h6 class="mb-0"><i class="fa-solid fa-calendar-check me-2"></i>{{ _('Scheduled chats') }}</h6>
        <button class="btn btn-sm btn-soft" type="button" data-bs-toggle="modal" data-bs-target="#scheduleModal"><i class="fa-solid fa-plus"></i></button>
      </div>
      <div class="contact-list list-group list-group-flush" id="scheduled-list" data-empty-text="{{ _('No scheduled chats yet.') }}">
        <div class="text-muted small">{{ _('No scheduled chats yet.') }}</div>
      </div>
    </div>
    {# Documentation card removed per new UI request #}
  </div>

  <div class="chat-area d-flex flex-column">
    <div class="card card-glass p-3 position-relative chat-card" id="chat-panel">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <div class="d-flex align-items-center gap-2">
          <button id="sidebar-toggle-btn" class="btn btn-outline-light" aria-expanded="true" aria-label="{{ _('Toggle sidebar') }}">
            <i class="fa-solid fa-bars"></i>
          </button>
          <div>
            <h5 class="mb-0" id="chat-title">{{ _('Select a group') }}</h5>
          </div>
        </div>
        <div class="d-flex gap-2 align-items-center">
          <button class="btn btn-sm btn-outline-light position-relative top-menu-btn" id="info-indicator" title="{{ _('No new notifications') }}">
            <i class="fa-solid fa-circle-info"></i>
            <span class="notification-dot d-none" id="info-dot"></span>
            <span class="notification-count d-none" id="info-count"></span>
          </button>
          <a class="btn btn-sm btn-outline-light top-menu-btn" href="{{ url_for('chat.help_page') }}" title="{{ _('Documentation') }}">
            <i class="fa-solid fa-book-open"></i>
          </a>
          <button class="btn btn-sm btn-outline-light top-menu-btn" id="theme-toggle" data-theme-toggle><i class="fa-solid fa-circle-half-stroke"></i></button>
        </div>
      </div>

      <div class="chat-panel-body d-flex flex-column">
        <div class="d-flex justify-content-center align-items-center load-older-banner d-none">
          <button type="button" class="btn btn-soft btn-sm" id="load-older-btn">{{ _('Load earlier messages') }}</button>
        </div>

        <div class="message-area flex-grow-1 d-flex flex-column position-relative">
          <div class="message-list" id="message-list"></div>
          <div class="message-loading d-none" id="message-loading">
            <div class="spinner-border text-accent" role="status" aria-label="{{ _('Loading messages') }}"></div>
          </div>
          <button type="button" class="scroll-top-btn" id="scroll-top-btn" aria-label="{{ _('Scroll to top') }}" aria-hidden="true">
            <i class="fa-solid fa-arrow-up"></i>
          </button>
        </div>
      </div>
    </div>

    <div class="card card-glass input-card mt-1 p-2 position-relative sticky-input d-flex flex-column" id="send-card" tabindex="-1">
      <div class="d-flex gap-2 align-items-center flex-wrap flex-md-nowrap input-row">
        <input type="file" id="file-input" class="d-none" accept="image/*,video/*,audio/*">
        <textarea class="form-control flex-grow-1" rows="2" id="message-input" placeholder="{{ _('Type an encrypted whisper...') }}" maxlength="5000"></textarea>
        <div class="d-flex align-items-center gap-2 flex-grow-1 flex-md-grow-0">
          <button class="btn btn-outline-light btn-sm flex-fill" id="attach-btn" title="{{ _('Attach') }}"><i class="fa-solid fa-paperclip"></i></button>
          <button class="btn btn-outline-light btn-sm flex-fill" id="emoji-btn" title="{{ _('Insert emoji') }}"><i class="fa-regular fa-face-smile"></i></button>
          <button class="btn btn-outline-light btn-sm flex-fill" id="record-btn" title="{{ _('Record voice note') }}"><i class="fa-solid fa-microphone"></i></button>
          <button class="btn btn-outline-light btn-sm flex-fill" id="refresh-btn" title="{{ _('Reload messages') }}"><i class="fa-solid fa-rotate-right"></i></button>
          <div id="upload-spinner" class="spinner-border spinner-border-sm text-info d-none" role="status"></div>
          <button class="btn btn-soft send-btn flex-fill" id="send-btn"><i class="fa-solid fa-paper-plane"></i></button>
        </div>
      </div>
      <div class="text-danger small mt-2 d-none" id="recording-indicator">{{ _('Recording… click mic to stop.') }}</div>
      <div class="emoji-picker d-none" id="emoji-picker" aria-label="Emoji picker"></div>
      <div class="d-flex justify-content-between align-items-center mt-2 text-muted small">
        <span><i class="fa-solid fa-lock"></i> {{ _('Client-side cryptography!') }}</span>
        <span id="message-count" class="text-muted"
          data-singular="{{ _('whisper') }}"
          data-plural="{{ _('whispers') }}">0 {{ _('whispers') }}</span>
      </div>
      <div class="text-center text-info small mt-1">
        <span id="typing-indicator" class="d-none"><i class="fa-solid fa-pen"></i> {{ _('typing...') }}</span>
      </div>
    </div>
  </div>
</div>

<!-- Create group modal -->
<div class="modal fade" id="createGroupModal" tabindex="-1" aria-labelledby="createGroupModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <form class="modal-content modal-schedule" id="create-group-form" action="{{ url_for('chat.create_group') }}" method="post">
      <div class="modal-header border-0">
        <h5 class="modal-title" id="createGroupModalLabel">{{ _('Create secure group') }}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{{ _('Close') }}"></button>
      </div>
      <div class="modal-body">
        {{ create_group_form.hidden_tag() }}
        <div class="mb-3">
          {{ create_group_form.name.label(class="form-label") }}
          {{ create_group_form.name(class="form-control", id="create-group-name") }}
        </div>
        <div class="mb-3">
          {{ create_group_form.secret.label(class="form-label mb-1") }}
          <div class="input-group">
            {{ create_group_form.secret(class="form-control", autocomplete="off", id="create-group-secret") }}
            <button type="button" class="btn btn-outline-light" id="create-gen-secret"><i class="fa-solid fa-wand-magic-sparkles"></i></button>
            <button type="button" class="btn btn-outline-light" id="create-copy-secret"><i class="fa-solid fa-copy"></i></button>
          </div>
          <small class="text-muted">{{ _('Use a strong secret (16+ characters recommended). This shared secret never leaves clients—distribute out-of-band.') }}</small>
        </div>
        <div class="alert alert-danger d-none" id="create-group-error" role="alert"></div>
      </div>
      <div class="modal-footer border-0">
        <button type="button" class="btn btn-ghost" data-bs-dismiss="modal">{{ _('Cancel') }}</button>
        <button type="submit" class="btn btn-soft" id="create-group-submit">{{ create_group_form.submit.label.text }}</button>
      </div>
    </form>
  </div>
</div>

<!-- Group created modal -->
<div class="modal fade" id="groupCreatedModal" tabindex="-1" aria-labelledby="groupCreatedModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content card-glass p-4 text-center">
      <div class="modal-header border-0">
        <h5 class="modal-title" id="groupCreatedModalLabel">{{ _('Group created') }}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{{ _('Close') }}"></button>
      </div>
      <div class="modal-body">
        <div class="p-3 bg-dark rounded-3 qr-card-wrapper">
          <img id="group-created-qr" src="" alt="{{ _('Group QR') }}" class="img-fluid rounded">
        </div>
        <p class="mt-3 text-muted small" id="group-created-hint">{{ _('Share this QR offline with trusted members. The server only stores a salted hash of the secret.') }}</p>
      </div>
      <div class="modal-footer border-0">
        <button type="button" class="btn btn-soft w-100" data-bs-dismiss="modal">{{ _('Close') }}</button>
      </div>
    </div>
  </div>
</div>

<!-- Schedule modal -->
<div class="modal fade" id="scheduleModal" tabindex="-1" aria-labelledby="scheduleModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content modal-schedule">
      <div class="modal-header border-0">
        <h5 class="modal-title" id="scheduleModalLabel">{{ _('Schedule chat') }}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label class="form-label">{{ _('Name') }}</label>
          <input type="text" class="form-control" id="sched-name" maxlength="128" placeholder="{{ _('Team catch-up') }}">
        </div>
        <div class="mb-3">
          <label class="form-label">{{ _('Start time') }}</label>
          <input type="datetime-local" class="form-control" id="sched-start">
        </div>
        <div class="mb-3">
          <label class="form-label">{{ _('End time') }}</label>
          <input type="datetime-local" class="form-control" id="sched-end">
        </div>
        <div class="form-check mb-3">
          <input class="form-check-input" type="checkbox" id="sched-never">
          <label class="form-check-label" for="sched-never">{{ _('Never expire') }}</label>
        </div>
      </div>
      <div class="modal-footer border-0">
        <button type="button" class="btn btn-ghost" data-bs-dismiss="modal">{{ _('Cancel') }}</button>
        <button type="button" class="btn btn-soft" id="sched-save">{{ _('Create') }}</button>
      </div>
  </div>
</div>
</div>

<!-- QR Scanner modal -->
<div class="modal fade" id="qrScannerModal" tabindex="-1" aria-labelledby="qrScannerModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-fullscreen-sm-down modal-dialog-centered">
    <div class="modal-content bg-dark text-light overflow-hidden">
      <div class="modal-header border-0">
        <h5 class="modal-title" id="qrScannerModalLabel">{{ _('Scan QR code') }}</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="{{ _('Close') }}"></button>
      </div>
      <div class="modal-body p-0 position-relative">
        <video id="qr-video" class="w-100 qr-scanner-video" playsinline muted></video>
        <canvas id="qr-canvas" class="d-none" aria-hidden="true"></canvas>
        <div class="qr-scanner-overlay">
          <span class="qr-scanner-target"></span>
        </div>
      </div>
      <div class="modal-footer border-0 justify-content-between">
        <button type="button" class="btn btn-outline-light" data-bs-dismiss="modal">{{ _('Cancel') }}</button>
        <span id="qr-scan-hint" class="text-muted small">{{ _('Point your camera at the QR to join instantly.') }}</span>
      </div>
    </div>
  </div>
</div>

<!-- Shared secret modal -->
<div class="modal fade" id="secretModal" tabindex="-1" aria-labelledby="secretModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content bg-dark text-light">
      <div class="modal-header border-0">
        <h5 class="modal-title" id="secretModalLabel">{{ _('Enter shared secret') }}</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p class="text-muted small mb-2">{{ _('This secret never leaves your device. It is required to decrypt and send messages in this group.') }}</p>
        <input type="hidden" id="secret-group-id">
        <input type="password" class="form-control" id="secret-input" placeholder="{{ _('Shared secret') }}" autocomplete="off">
        <div class="text-danger small mt-2 d-none" id="secret-error">{{ _('Secret is required.') }}</div>
        <div class="form-check mt-3">
          <input class="form-check-input" type="checkbox" value="" id="remember-secret">
          <label class="form-check-label" for="remember-secret">
            {{ _('Remember for this session') }}
          </label>
        </div>
        <div class="form-check mt-2">
          <input class="form-check-input" type="checkbox" value="" id="remember-secret-permanent">
          <label class="form-check-label text-warning" for="remember-secret-permanent">
            {{ _('Save secret in this browser (unsafe)') }}
          </label>
        </div>
      </div>
      <div class="modal-footer border-0">
        <button type="button" class="btn btn-outline-light" data-bs-dismiss="modal">{{ _('Cancel') }}</button>
        <button type="button" class="btn btn-soft" id="secret-save">{{ _('Save secret') }}</button>
      </div>
    </div>
  </div>
</div>

<!-- Delete group modal -->
<div class="modal fade" id="deleteGroupModal" tabindex="-1" aria-labelledby="deleteGroupModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content bg-dark text-light">
      <div class="modal-header border-0">
        <h5 class="modal-title" id="deleteGroupModalLabel">{{ _('Delete group') }}</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p class="mb-2">{{ _('This will delete the group and all encrypted data for') }} <span id="delete-group-name" class="fw-semibold"></span>.</p>
        <p class="text-danger small mb-0">{{ _('Action is irreversible.') }}</p>
      </div>
      <div class="modal-footer border-0">
        <button type="button" class="btn btn-outline-light" data-bs-dismiss="modal">{{ _('Cancel') }}</button>
        <button type="button" class="btn btn-danger" id="confirm-delete-group">{{ _('Delete') }}</button>
      </div>
    </div>
  </div>
</div>

<!-- Delete message modal -->
<div class="modal fade" id="deleteMessageModal" tabindex="-1" aria-labelledby="deleteMessageModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content bg-dark text-light">
      <div class="modal-header border-0">
        <h5 class="modal-title" id="deleteMessageModalLabel">{{ _('Delete message') }}</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p class="mb-0">{{ _('Are you sure you want to delete this message?') }}</p>
      </div>
      <div class="modal-footer border-0">
        <button type="button" class="btn btn-outline-light" data-bs-dismiss="modal">{{ _('Cancel') }}</button>
        <button type="button" class="btn btn-danger" id="confirm-delete-message">{{ _('Delete') }}</button>
      </div>
    </div>
  </div>
</div>

<!-- DM modal -->
<div class="modal fade" id="dmModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content bg-dark text-light">
      <div class="modal-header border-0">
        <h5 class="modal-title">{{ _('Start private chat') }}</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p class="text-muted">{{ _('Enter a shared secret for this private conversation. It will be used to derive your E2EE key.') }}</p>
        <input type="hidden" id="dm-user-id">
        <div class="mb-3">
          <label class="form-label">{{ _('Secret') }}</label>
          <div class="input-group">
            <input type="password" class="form-control" id="dm-secret" autocomplete="off" minlength="12">
            <button class="btn btn-outline-light" type="button" id="dm-secret-toggle" aria-label="{{ _('Show secret') }}"><i class="fa-solid fa-eye"></i></button>
            <button class="btn btn-outline-light" type="button" id="dm-secret-gen" aria-label="{{ _('Generate secret') }}"><i class="fa-solid fa-wand-magic-sparkles"></i></button>
            <button class="btn btn-outline-light" type="button" id="dm-secret-copy" aria-label="{{ _('Copy secret') }}"><i class="fa-solid fa-copy"></i></button>
          </div>
          <div class="form-text text-muted">{{ _('Minimum 12 characters.') }}</div>
        </div>
      </div>
      <div class="modal-footer border-0">
        <button type="button" class="btn btn-outline-light" data-bs-dismiss="modal">{{ _('Cancel') }}</button>
        <button type="button" class="btn btn-soft" id="dm-start-btn">{{ _('Start') }}</button>
      </div>
    </div>
  </div>
</div>

<!-- Media modal -->
<div class="modal fade" id="mediaModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content bg-dark text-light position-relative">
      <div class="modal-header border-0 pb-0">
        <h5 class="modal-title">Media preview</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body text-center" id="mediaModalBody"></div>
    </div>
  </div>
</div>

<!-- Info modal -->
<div class="modal fade" id="infoModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content bg-dark text-light">
      <div class="modal-header border-0">
        <h5 class="modal-title" id="infoModalTitle">Notice</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="infoModalBody"></div>
      <div class="modal-footer border-0">
        <button type="button" class="btn btn-soft" data-bs-dismiss="modal">OK</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="{{ url_for('static', filename='js/chat.js', v=config.APP_VERSION) }}"></script>
{% include 'modals/scheduled_delete.html' %}
<script>
  (() => {
    const sidebar = document.getElementById('groupSidebar');
    if (!sidebar || typeof bootstrap === 'undefined') return;
    let userToggled = false;
    const toggleBtns = document.querySelectorAll('[data-bs-target=\"#groupSidebar\"]');
    toggleBtns.forEach((btn) => {
      btn.addEventListener('click', () => { userToggled = true; });
    });
    const syncSidebar = () => {
      const isDesktop = window.matchMedia('(min-width: 992px)').matches;
      const inst = bootstrap.Collapse.getOrCreateInstance(sidebar, { toggle: false });
      if (isDesktop && !userToggled) {
        inst.show();
      }
      if (!isDesktop) {
        inst.hide();
        userToggled = false;
      }
    };
    window.addEventListener('resize', syncSidebar);
    syncSidebar();
  })();
</script>
<script>
  (() => {
    const form = document.getElementById('create-group-form');
    const modalEl = document.getElementById('createGroupModal');
    if (!form || !modalEl || typeof bootstrap === 'undefined') return;
    const submitBtn = document.getElementById('create-group-submit');
    const errorEl = document.getElementById('create-group-error');
    const qrModalEl = document.getElementById('groupCreatedModal');
    const qrImg = document.getElementById('group-created-qr');
    const qrTitle = document.getElementById('groupCreatedModalLabel');
    const qrHint = document.getElementById('group-created-hint');
    const genBtn = document.getElementById('create-gen-secret');
    const copyBtn = document.getElementById('create-copy-secret');
    const secretInput = document.getElementById('create-group-secret');
    const modalInstance = bootstrap.Modal.getOrCreateInstance(modalEl);
    const qrModalInstance = bootstrap.Modal.getOrCreateInstance(qrModalEl);

    const randomSecret = (len = 24) => {
      const chars = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*()-_=+';
      let out = '';
      const arr = crypto.getRandomValues(new Uint32Array(len));
      for (let i = 0; i < len; i += 1) {
        out += chars[arr[i] % chars.length];
      }
      return out;
    };

    const copySecretValue = async (value) => {
      if (!value) return false;
      try {
        if (navigator?.clipboard?.writeText) {
          await navigator.clipboard.writeText(value);
          return true;
        }
      } catch (err) {
        // fall through to legacy path
      }
      try {
        const textarea = document.createElement('textarea');
        textarea.value = value;
        textarea.setAttribute('readonly', '');
        textarea.style.position = 'fixed';
        textarea.style.top = '-1000px';
        textarea.setAttribute('aria-hidden', 'true');
        document.body.appendChild(textarea);
        textarea.select();
        textarea.setSelectionRange(0, textarea.value.length);
        const succeeded = document.execCommand('copy');
        document.body.removeChild(textarea);
        return succeeded;
      } catch (err) {
        return false;
      }
    };

    const showError = (message) => {
      if (!errorEl) return;
      errorEl.textContent = message;
      errorEl.classList.remove('d-none');
    };

    form.addEventListener('submit', async (event) => {
      event.preventDefault();
      if (submitBtn) submitBtn.disabled = true;
      if (errorEl) errorEl.classList.add('d-none');
      try {
        const response = await fetch(form.action, {
          method: form.method || 'POST',
          headers: { 'X-Requested-With': 'XMLHttpRequest' },
          body: new FormData(form),
        });
        let payload;
        try {
          payload = await response.json();
        } catch (err) {
          payload = null;
        }
        if (!response.ok || !payload?.ok) {
          const errors = payload?.errors;
          const details = errors ? Object.values(errors).flat().join(' ') : payload?.message;
          showError(details || "{{ _('Unable to create group at the moment.') }}");
          return;
        }
        modalInstance.hide();
        if (payload?.group?.name) {
          qrTitle.textContent = `${payload.group.name} {{ _('created') }}`;
        }
        if (qrHint) {
          qrHint.textContent = payload?.message || "{{ _('Share this QR offline with trusted members. The server only stores a salted hash of the secret.') }}";
        }
        if (qrImg && payload?.qr_data) {
          qrImg.src = payload.qr_data;
        }
        qrModalInstance.show();
        form.reset();
        if (window.showToast) {
          window.showToast('success', payload?.message || "{{ _('Group created') }}");
        }
        if (typeof fetchGroups === 'function') {
          fetchGroups().catch(() => {});
        }
      } catch (err) {
        console.error('create group modal failed', err);
        showError("{{ _('Unable to reach the server. Try again shortly.') }}");
      } finally {
        if (submitBtn) submitBtn.disabled = false;
      }
    });

    genBtn?.addEventListener('click', () => {
      if (secretInput) {
        secretInput.value = randomSecret();
      }
    });

    copyBtn?.addEventListener('click', async () => {
      const ok = await copySecretValue(secretInput?.value || '');
      try {
        window.showToast?.(
          ok ? 'success' : 'error',
          ok ? "{{ _('Copied') }}" : "{{ _('Copy failed') }}",
          ok ? "{{ _('Secret copied to clipboard.') }}" : "{{ _('Clipboard is blocked in this browser.') }}"
        );
      } catch (err) {
        // ignore toast errors
      }
    });
  })();
</script>
{% endblock %}
