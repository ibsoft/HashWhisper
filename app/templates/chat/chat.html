{% extends 'base.html' %}
{% block content %}
<div class="chat-shell" data-user-id="{{ current_user.id }}" data-username="{{ current_user.username }}" data-max-bytes="{{ config.MAX_CONTENT_LENGTH }}" data-user-tz="{{ current_user.timezone or 'UTC' }}" data-ai-enabled="{{ 'true' if config.AI_ENABLED else 'false' }}" data-allow-delete="{{ 'true' if config.ALLOW_MESSAGE_DELETE else 'false' }}" data-default-avatar="{{ default_avatar }}">
<div class="desktop-spaces sidebar-column" id="groupSidebar">
    <div class="card card-glass p-3 sidebar-card mb-3">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="mb-0"><i class="fa-solid fa-layer-group me-2"></i>{{ _('Whisper Rooms') }}</h5>
        <div class="btn-group">
          <button class="btn btn-sm btn-soft" type="button" title="{{ _('Create group') }}" data-bs-toggle="modal" data-bs-target="#createGroupModal">
            <i class="fa-solid fa-plus"></i>
          </button>
        </div>
      </div>
      <div class="contact-list list-group list-group-flush" id="group-list">
          {% for g in groups %}
            <div class="list-group-item d-flex justify-content-between align-items-center bg-transparent text-start text-light border-0">
              <button class="btn btn-link text-start text-light flex-grow-1 position-relative" data-group-id="{{ g.id }}" data-group-name="{{ g.name }}">
                <i class="fa-solid fa-hashtag me-2"></i><span class="group-name">{{ g.name }}</span>
                <span class="secret-dot ms-2" data-secret-dot="{{ g.id }}"></span>
              </button>
              {% if g.created_by == current_user.id %}
              <button class="btn btn-outline-danger btn-sm delete-group" data-delete-group="{{ g.id }}" data-group-name="{{ g.name }}" title="Delete group">
                <i class="fa-solid fa-trash"></i>
              </button>
              {% endif %}
            </div>
          {% else %}
            <p class="text-muted">{{ _('No groups yet. Create or join using a secret hash.') }}</p>
          {% endfor %}
      </div>
      <div class="users-divider">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h6 class="mb-0"><i class="fa-solid fa-user-group me-2"></i>{{ _('Users') }}</h6>
        </div>
      </div>
      <div class="contact-list list-group list-group-flush" id="user-list"></div>
    </div>
    <div class="card card-glass p-3 sidebar-card mb-3">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h6 class="mb-0">{{ _('Join via secret hash') }}</h6>
      </div>
      <input type="text" class="form-control mb-2" id="join-group-name" placeholder="{{ _('Group name') }}">
      <div class="input-group">
        <input type="password" class="form-control" id="join-secret" placeholder="{{ _('Paste shared secret') }}" autocomplete="off">
        <button class="btn btn-outline-light" type="button" id="join-secret-toggle" aria-label="{{ _('Show secret') }}">
          <i class="fa-solid fa-eye"></i>
        </button>
      </div>
      <button class="btn btn-outline-light w-100 mt-2" id="join-btn">{{ _('Join securely') }}</button>
      <button type="button" class="btn btn-info w-100 mt-2 d-lg-none" id="scan-qr-btn">
        <i class="fa-solid fa-qrcode me-1"></i>{{ _('Scan QR code') }}
      </button>
      <p class="text-muted small mt-1 d-lg-none">{{ _('Point your camera at the QR to join instantly.') }}</p>
      <div
        id="qr-scan-text"
        class="d-none"
        data-camera-missing="{{ _('Scanning requires a device camera.') }}"
        data-camera-denied="{{ _('Allow camera access to continue.') }}"
        data-invalid="{{ _('This QR code does not contain a valid invitation.') }}"
        data-join-failed="{{ _('Unable to join the space from this QR code.') }}"
        data-library-missing="{{ _('Unable to load the QR decoder.') }}"
      ></div>
      <div id="qr-join-config" data-join-url="{{ url_for('chat.join_group') }}"></div>
    </div>

    <div class="card card-glass p-3 sidebar-card mb-3">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h6 class="mb-0 favorites-title"><i class="fa-solid fa-star me-2"></i>{{ _('Favorites') }}</h6>
      </div>
      <div class="contact-list list-group list-group-flush" id="favorite-list">
        <div class="text-muted small">{{ _('No favorites yet.') }}</div>
      </div>
    </div>

    <div class="card card-glass p-3 sidebar-card mb-3 search-card" id="message-search-card">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h6 class="mb-0"><i class="fa-solid fa-magnifying-glass me-2"></i>{{ _('Search current chat') }}</h6>
      </div>
      <input
        type="search"
        class="form-control"
        id="message-search-input"
        placeholder="{{ _('Search decrypted messages in this room') }}"
        autocomplete="off"
      >
      <div class="search-results mt-2 text-muted small" id="search-results">
        {{ _('Type to filter the currently loaded chat history.') }}
      </div>
    </div>

    <div class="card card-glass p-3 sidebar-card mb-3">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h6 class="mb-0"><i class="fa-solid fa-sliders me-2"></i>{{ _('Quick Actions') }}</h6>
      </div>
        <div class="quick-actions-grid">
          <button class="btn btn-sm btn-outline-light quick-action-btn position-relative top-menu-btn" id="info-indicator" title="{{ _('No new notifications') }}">
            <i class="fa-solid fa-circle-info"></i>
            <span class="notification-dot d-none" id="info-dot"></span>
            <span class="notification-count d-none" id="info-count"></span>
          </button>
          <a class="btn btn-sm btn-outline-light quick-action-btn top-menu-btn" href="{{ url_for('settings.settings') }}" title="{{ _('Settings') }}">
            <i class="fa-solid fa-gear"></i>
          </a>
          <button class="btn btn-sm btn-outline-light quick-action-btn top-menu-btn" id="theme-toggle" data-theme-toggle>
            <i class="fa-solid fa-circle-half-stroke"></i>
          </button>
          {% if config.SHOW_VAULT_QUICK_ACTION %}
          <button class="btn btn-sm btn-outline-light quick-action-btn top-menu-btn" id="vault-quick-action" type="button" title="{{ _('Share a one-time secret') }}">
            <i class="fa-solid fa-shield-halved"></i>
          </button>
          {% endif %}
          {% if config.SHOW_PASSWORD_GENERATOR_QUICK_ACTION %}
          <button class="btn btn-sm btn-outline-light quick-action-btn top-menu-btn" id="password-generator-action" type="button" title="{{ _('Generate a strong password') }}">
            <i class="fa-solid fa-key"></i>
          </button>
          {% endif %}
          <a class="btn btn-sm btn-outline-light quick-action-btn top-menu-btn logout-btn" href="{{ url_for('auth.logout') }}" data-logout title="{{ _('Logout') }}">
            <i class="fa-solid fa-right-from-bracket"></i>
          </a>
        </div>
    </div>

    <div class="card card-glass p-3 sidebar-card">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h6 class="mb-0"><i class="fa-solid fa-calendar-check me-2"></i>{{ _('Scheduled chats') }}</h6>
        <button class="btn btn-sm btn-soft" type="button" data-bs-toggle="modal" data-bs-target="#scheduleModal"><i class="fa-solid fa-plus"></i></button>
      </div>
      <div class="contact-list list-group list-group-flush" id="scheduled-list" data-empty-text="{{ _('No scheduled chats yet.') }}">
        <div class="text-muted small">{{ _('No scheduled chats yet.') }}</div>
      </div>
    </div>
    {# Documentation card removed per new UI request #}
  </div>

  <div class="chat-area d-flex flex-column">
    <div class="card card-glass p-3 position-relative chat-card" id="chat-panel">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <div class="d-flex align-items-center gap-2">
          <button id="sidebar-toggle-btn" class="btn btn-outline-light" aria-expanded="true" aria-label="{{ _('Toggle sidebar') }}">
            <i class="fa-solid fa-bars"></i>
          </button>
          <div>
            <h5 class="mb-0" id="chat-title">{{ _('Select a group') }}</h5>
          </div>
        </div>
        <div class="d-flex gap-2 align-items-center">
          <button class="btn btn-sm btn-outline-light top-menu-btn" id="share-secret-btn" title="{{ _('Share secret') }}" disabled>
            <i class="fa-solid fa-share-nodes"></i>
          </button>
        </div>
      </div>

      <div class="chat-panel-body d-flex flex-column">
        <div class="d-flex justify-content-center align-items-center load-older-banner d-none">
          <button type="button" class="btn btn-soft btn-sm" id="load-older-btn">{{ _('Load earlier messages') }}</button>
        </div>

        <div class="message-area flex-grow-1 d-flex flex-column position-relative">
          <div class="message-list" id="message-list"></div>
          <div class="message-loading d-none" id="message-loading">
            <div class="spinner-border text-accent" role="status" aria-label="{{ _('Loading messages') }}"></div>
          </div>
        </div>
    </div>
  </div>

    <div class="scroll-control-wrapper d-flex justify-content-end mt-2 px-2">
      <button type="button" class="scroll-top-btn" id="scroll-top-btn" aria-label="{{ _('Scroll to top') }}" aria-hidden="true">
        <i class="fa-solid fa-arrow-up"></i>
      </button>
    </div>

    <div class="card card-glass input-card mt-1 p-2 position-relative sticky-input d-flex flex-column" id="send-card" tabindex="-1">
      <div class="d-flex gap-2 align-items-center flex-wrap flex-md-nowrap input-row">
        <input type="file" id="file-input" class="d-none" accept="image/*,video/*,audio/*">
        <textarea class="form-control flex-grow-1" rows="2" id="message-input" placeholder="{{ _('Type an encrypted whisper...') }}" maxlength="5000"></textarea>
        <div class="d-flex align-items-center gap-2 flex-grow-1 flex-md-grow-0">
          <button class="btn btn-outline-light btn-sm flex-fill" id="attach-btn" title="{{ _('Attach') }}"><i class="fa-solid fa-paperclip"></i></button>
          <button class="btn btn-outline-light btn-sm flex-fill" id="emoji-btn" title="{{ _('Insert emoji') }}"><i class="fa-regular fa-face-smile"></i></button>
          <button class="btn btn-outline-light btn-sm flex-fill" id="record-btn" title="{{ _('Record voice note') }}"><i class="fa-solid fa-microphone"></i></button>
          <button class="btn btn-outline-light btn-sm flex-fill" id="refresh-btn" title="{{ _('Reload messages') }}"><i class="fa-solid fa-rotate-right"></i></button>
          <div id="upload-spinner" class="spinner-border spinner-border-sm text-info d-none" role="status"></div>
          <button class="btn btn-soft send-btn flex-fill" id="send-btn"><i class="fa-solid fa-paper-plane"></i></button>
        </div>
      </div>
      <div class="text-danger small mt-2 d-none" id="recording-indicator">{{ _('Recording… click mic to stop.') }}</div>
      <div class="emoji-picker d-none" id="emoji-picker" aria-label="Emoji picker"></div>
      <div class="d-flex justify-content-between align-items-center mt-2 text-muted small">
        <span><i class="fa-solid fa-lock"></i> {{ _('Client-side cryptography!') }}</span>
        <span id="message-count" class="text-muted"
          data-singular="{{ _('whisper') }}"
          data-plural="{{ _('whispers') }}">0 {{ _('whispers') }}</span>
      </div>
      <div class="text-center text-info small mt-1">
        <span id="typing-indicator" class="d-none"><i class="fa-solid fa-pen"></i> {{ _('typing...') }}</span>
      </div>
    </div>
  </div>
</div>

<!-- Create group modal -->
<div class="modal fade" id="createGroupModal" tabindex="-1" aria-labelledby="createGroupModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <form class="modal-content modal-schedule" id="create-group-form" action="{{ url_for('chat.create_group') }}" method="post">
      <div class="modal-header border-0">
        <h5 class="modal-title" id="createGroupModalLabel">{{ _('Create secure group') }}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{{ _('Close') }}"></button>
      </div>
      <div class="modal-body">
        {{ create_group_form.hidden_tag() }}
        <div class="mb-3">
          {{ create_group_form.name.label(class="form-label") }}
          {{ create_group_form.name(class="form-control", id="create-group-name") }}
        </div>
        <div class="mb-3">
          {{ create_group_form.secret.label(class="form-label mb-1") }}
          <div class="input-group">
            {{ create_group_form.secret(class="form-control", autocomplete="off", id="create-group-secret") }}
            <button type="button" class="btn btn-outline-light" id="create-gen-secret"><i class="fa-solid fa-wand-magic-sparkles"></i></button>
            <button type="button" class="btn btn-outline-light" id="create-copy-secret"><i class="fa-solid fa-copy"></i></button>
          </div>
          <small class="text-muted">{{ _('Use a strong secret (16+ characters recommended). This shared secret never leaves clients—distribute out-of-band.') }}</small>
        </div>
        <div class="alert alert-danger d-none" id="create-group-error" role="alert"></div>
      </div>
      <div class="modal-footer border-0">
        <button type="button" class="btn btn-ghost" data-bs-dismiss="modal">{{ _('Cancel') }}</button>
        <button type="submit" class="btn btn-soft" id="create-group-submit">{{ create_group_form.submit.label.text }}</button>
      </div>
    </form>
  </div>
</div>

<!-- Group created modal -->
<div class="modal fade" id="groupCreatedModal" tabindex="-1" aria-labelledby="groupCreatedModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content card-glass p-4 text-center">
      <div class="modal-header border-0">
        <h5 class="modal-title" id="groupCreatedModalLabel">{{ _('Group created') }}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{{ _('Close') }}"></button>
      </div>
      <div class="modal-body">
        <div class="p-3 bg-dark rounded-3 qr-card-wrapper">
          <img id="group-created-qr" src="" alt="{{ _('Group QR') }}" class="img-fluid rounded">
        </div>
        <p class="mt-3 text-muted small" id="group-created-hint">{{ _('Share this QR offline with trusted members. The server only stores a salted hash of the secret.') }}</p>
      </div>
      <div class="modal-footer border-0">
        <button type="button" class="btn btn-soft w-100" data-bs-dismiss="modal">{{ _('Close') }}</button>
      </div>
    </div>
  </div>
</div>

<!-- Schedule modal -->
<div class="modal fade" id="scheduleModal" tabindex="-1" aria-labelledby="scheduleModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content modal-schedule">
      <div class="modal-header border-0">
        <h5 class="modal-title" id="scheduleModalLabel">{{ _('Schedule chat') }}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label class="form-label">{{ _('Name') }}</label>
          <input type="text" class="form-control" id="sched-name" maxlength="128" placeholder="{{ _('Team catch-up') }}">
        </div>
        <div class="mb-3">
          <label class="form-label">{{ _('Start time') }}</label>
          <input type="datetime-local" class="form-control" id="sched-start">
        </div>
        <div class="mb-3">
          <label class="form-label">{{ _('End time') }}</label>
          <input type="datetime-local" class="form-control" id="sched-end">
        </div>
        <div class="form-check mb-3">
          <input class="form-check-input" type="checkbox" id="sched-never">
          <label class="form-check-label" for="sched-never">{{ _('Never expire') }}</label>
        </div>
      </div>
      <div class="modal-footer border-0">
        <button type="button" class="btn btn-ghost" data-bs-dismiss="modal">{{ _('Cancel') }}</button>
        <button type="button" class="btn btn-soft" id="sched-save">{{ _('Create') }}</button>
      </div>
  </div>
</div>
</div>

<!-- QR Scanner modal -->
<div class="modal fade" id="qrScannerModal" tabindex="-1" aria-labelledby="qrScannerModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-fullscreen-sm-down modal-dialog-centered">
    <div class="modal-content bg-dark text-light overflow-hidden">
      <div class="modal-header border-0">
        <h5 class="modal-title" id="qrScannerModalLabel">{{ _('Scan QR code') }}</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="{{ _('Close') }}"></button>
      </div>
      <div class="modal-body p-0 position-relative">
        <video id="qr-video" class="w-100 qr-scanner-video" playsinline muted></video>
        <canvas id="qr-canvas" class="d-none" aria-hidden="true"></canvas>
        <div class="qr-scanner-overlay">
          <span class="qr-scanner-target"></span>
        </div>
      </div>
      <div class="modal-footer border-0 justify-content-between">
        <button type="button" class="btn btn-outline-light" data-bs-dismiss="modal">{{ _('Cancel') }}</button>
        <span id="qr-scan-hint" class="text-muted small">{{ _('Point your camera at the QR to join instantly.') }}</span>
      </div>
    </div>
  </div>
</div>

<!-- Shared secret modal -->
<div class="modal fade" id="secretModal" tabindex="-1" aria-labelledby="secretModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content bg-dark text-light">
      <div class="modal-header border-0">
        <h5 class="modal-title" id="secretModalLabel">{{ _('Enter shared secret') }}</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p class="text-muted small mb-2">{{ _('This secret never leaves your device. It is required to decrypt and send messages in this group.') }}</p>
        <input type="hidden" id="secret-group-id">
        <input type="password" class="form-control" id="secret-input" placeholder="{{ _('Shared secret') }}" autocomplete="off">
        <div class="text-danger small mt-2 d-none" id="secret-error">{{ _('Secret is required.') }}</div>
        <div class="form-check mt-3">
          <input class="form-check-input" type="checkbox" value="" id="remember-secret">
          <label class="form-check-label" for="remember-secret">
            {{ _('Remember for this session') }}
          </label>
        </div>
        <div class="form-check mt-2">
          <input class="form-check-input" type="checkbox" value="" id="remember-secret-permanent">
          <label class="form-check-label text-warning" for="remember-secret-permanent">
            {{ _('Save secret in this browser (unsafe)') }}
          </label>
        </div>
      </div>
      <div class="modal-footer border-0">
        <button type="button" class="btn btn-outline-light" data-bs-dismiss="modal">{{ _('Cancel') }}</button>
        <button type="button" class="btn btn-soft" id="secret-save">{{ _('Save secret') }}</button>
  </div>
</div>
</div>

<!-- One-time vault modal -->
<div class="modal fade" id="vaultModal" tabindex="-1" aria-labelledby="vaultModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content bg-dark text-light">
      <div class="modal-header border-0">
        <h5 class="modal-title" id="vaultModalLabel">{{ _('Share a one-time secret') }}</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="{{ _('Close') }}"></button>
      </div>
      <div class="modal-body">
        <p class="text-muted small mb-3">{{ _('Write a secure note, password, or link. The browser encrypts it while the server only stores ciphertext.') }}</p>
        <form id="vault-form">
          <div class="mb-3">
            <label class="form-label">{{ _('Title (optional)') }}</label>
            <input type="text" class="form-control" id="vault-title" placeholder="{{ _('e.g. Wi-Fi credentials') }}">
          </div>
          <div class="mb-3">
            <label class="form-label">{{ _('Secret note') }}</label>
            <textarea class="form-control" id="vault-message" rows="4" placeholder="{{ _('Type or paste the content you want to share securely...') }}"></textarea>
          </div>
          <div class="mb-3">
            <label class="form-label d-flex justify-content-between">
              <span>{{ _('File attachment (optional)') }}</span>
              <span class="text-muted small">{{ _('Max %(size)s MB', size=(config.VAULT_MAX_FILE_SIZE / (1024 * 1024))|round(1)) }}</span>
            </label>
            <input
              type="file"
              class="form-control"
              id="vault-file"
              accept="{{ config.VAULT_FILE_ACCEPT }}"
              data-max-size="{{ config.VAULT_MAX_FILE_SIZE }}"
              data-allowed-mimes="{{ config.VAULT_FILE_MIMETYPES | join(',') }}"
            >
            <div
              class="form-text text-muted small"
              id="vault-file-feedback"
              data-default-message="{{ _('Supports doc/docx, xls/xlsx, pdf, png/jpg/webp, txt/log/json, mp3/wav/webm voice notes.') }}"
            >
              {{ _('Supports doc/docx, xls/xlsx, pdf, png/jpg/webp, txt/log/json, mp3/wav/webm voice notes.') }}
            </div>
            <div class="d-flex align-items-center gap-2 mt-2">
              <div class="spinner-border spinner-border-sm text-primary d-none" role="status" id="vault-file-spinner" aria-hidden="true"></div>
              <span class="small text-muted d-none" id="vault-file-spinner-label">{{ _('Processing attachment...') }}</span>
            </div>
            <div class="text-muted small mt-1 d-none" id="vault-file-info"></div>
          </div>
          <div class="row gx-2">
            <div class="col-sm-6 mb-3">
              <label class="form-label">{{ _('Lifetime') }}</label>
              <select class="form-select" id="vault-lifetime">
                <option value="1">{{ _('1 hour') }}</option>
                <option value="3">{{ _('3 hours') }}</option>
                <option value="24" selected>{{ _('24 hours') }}</option>
                <option value="72">{{ _('72 hours') }}</option>
                <option value="0">{{ _('Never (not recommended)') }}</option>
              </select>
            </div>
            <div class="col-sm-6 mb-3">
              <label class="form-label">{{ _('Views allowed') }}</label>
              <select class="form-select" id="vault-views">
                <option value="1">{{ _('Burn after 1 view') }}</option>
                <option value="2">{{ _('Up to 2 views') }}</option>
                <option value="5">{{ _('Up to 5 views') }}</option>
                <option value="10">{{ _('Up to 10 views') }}</option>
              </select>
            </div>
          </div>
          <div class="form-check form-switch mb-3">
            <input class="form-check-input" type="checkbox" id="vault-burn-switch" checked>
            <label class="form-check-label" for="vault-burn-switch">{{ _('Burn immediately after the first view (uncheck to allow the number of views above)') }}</label>
          </div>
          <div class="alert alert-danger d-none" id="vault-error" role="alert"></div>
          <div class="alert alert-success d-none" id="vault-result" role="status">
            <div class="small text-success mb-2" id="vault-result-meta"></div>
            <div class="text-success small mt-1 d-none" id="vault-copy-status">{{ _('Link copied to clipboard.') }}</div>
            <div class="mb-2">
              <label class="form-label small mb-1">{{ _('Shareable link (copy the full URL)') }}</label>
              <div class="input-group input-group-sm">
                <input type="text" class="form-control" id="vault-share-url" readonly>
                <button class="btn btn-outline-light" type="button" id="vault-copy-url"><i class="fa-solid fa-copy"></i></button>
              </div>
            </div>
            <div>
              <label class="form-label small mb-1">{{ _('Secret fragment (keep the part after the # private)') }}</label>
              <div class="input-group input-group-sm">
                <input type="text" class="form-control" id="vault-share-secret" readonly>
                <button class="btn btn-outline-light" type="button" id="vault-copy-secret"><i class="fa-solid fa-copy"></i></button>
              </div>
            </div>
            <p class="text-muted small mt-2 mb-0">{{ _('Provide the secret fragment to the recipient separately; the server never stores it.') }}</p>
          </div>
          <small class="text-muted d-block mt-2">{{ _('Created links expire automatically after their lifetime or the allowed views are consumed.') }}</small>
        </form>
      </div>
      <div class="modal-footer border-0">
        <button type="button" class="btn btn-ghost" data-bs-dismiss="modal">{{ _('Cancel') }}</button>
        <button type="button" class="btn btn-soft" id="vault-create">{{ _('Create secret link') }}</button>
      </div>
    </div>
  </div>
</div>

<!-- Password generator modal -->
<div class="modal fade" id="passwordGeneratorModal" tabindex="-1" aria-labelledby="passwordGeneratorModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content bg-dark text-light">
      <div class="modal-header border-0">
        <h5 class="modal-title" id="passwordGeneratorModalLabel">{{ _('Password generator') }}</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="{{ _('Close') }}"></button>
      </div>
      <div class="modal-body">
        <p class="text-muted small mb-3">{{ _('Create a strong password and copy it instantly. Adjust length and character sets as needed.') }}</p>
        <div class="mb-3">
          <label class="form-label d-flex justify-content-between">
            <span>{{ _('Length') }}</span>
            <span id="password-length-value" class="text-muted">16</span>
          </label>
          <input type="range" class="form-range" min="8" max="64" value="16" id="password-length">
        </div>
        <div class="row gx-2 mb-3">
          <div class="col-6">
            <label class="form-label">{{ _('Character sets') }}</label>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="password-upper" checked>
              <label class="form-check-label" for="password-upper">{{ _('Uppercase') }}</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="password-lower" checked>
              <label class="form-check-label" for="password-lower">{{ _('Lowercase') }}</label>
            </div>
          </div>
          <div class="col-6">
            <label class="form-label">{{ _('Digits & symbols') }}</label>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="password-numeric" checked>
              <label class="form-check-label" for="password-numeric">{{ _('Digits') }}</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="password-symbols" checked>
              <label class="form-check-label" for="password-symbols">{{ _('Symbols') }}</label>
            </div>
          </div>
        </div>
        <div class="input-group mb-3">
          <input type="text" class="form-control" id="generated-password" readonly>
          <button class="btn btn-outline-light" type="button" id="copy-password"><i class="fa-solid fa-copy"></i></button>
        </div>
        <div class="d-grid gap-2">
          <button class="btn btn-soft" type="button" id="generate-password">{{ _('Generate password') }}</button>
        </div>
      </div>
      <div class="modal-footer border-0">
        <button type="button" class="btn btn-ghost" data-bs-dismiss="modal">{{ _('Close') }}</button>
        </div>
      </div>
    </div>
  </div>
</div>

  <script>
    window.HW_VAULT_MESSAGES = {
      fileTooLarge: {{ _('File exceeds maximum allowed size.') | tojson }},
      fileTypeNotAllowed: {{ _('File type not allowed.') | tojson }},
      fileReadError: {{ _('Unable to read this file.') | tojson }},
      waitForAttachment: {{ _('Please wait for the file to finish loading.') | tojson }},
      provideTextOrFile: {{ _('Provide some text or attach a file.') | tojson }},
      payloadMissing: {{ _('Payload missing.') | tojson }},
      unableCreateSecret: {{ _('Unable to create secret link.') | tojson }},
      neverLabel: {{ _('Never') | tojson }},
      secretLinkCreated: {{ _('Secret link created') | tojson }},
      secretLinkCopy: {{ _('Copy the link and the secret fragment separately.') | tojson }},
      unableReachVault: {{ _('Unable to reach the vault service right now.') | tojson }},
      attachmentLabel: {{ _('File attached:') | tojson }},
    };
  </script>

<!-- Delete group modal -->
<div class="modal fade" id="deleteGroupModal" tabindex="-1" aria-labelledby="deleteGroupModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content bg-dark text-light">
      <div class="modal-header border-0">
        <h5 class="modal-title" id="deleteGroupModalLabel">{{ _('Delete group') }}</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p class="mb-2">{{ _('This will delete the group and all encrypted data for') }} <span id="delete-group-name" class="fw-semibold"></span>.</p>
        <p class="text-danger small mb-0">{{ _('Action is irreversible.') }}</p>
      </div>
      <div class="modal-footer border-0">
        <button type="button" class="btn btn-outline-light" data-bs-dismiss="modal">{{ _('Cancel') }}</button>
        <button type="button" class="btn btn-danger" id="confirm-delete-group">{{ _('Delete') }}</button>
      </div>
    </div>
  </div>
</div>

<!-- Delete message modal -->
<div class="modal fade" id="deleteMessageModal" tabindex="-1" aria-labelledby="deleteMessageModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content bg-dark text-light">
      <div class="modal-header border-0">
        <h5 class="modal-title" id="deleteMessageModalLabel">{{ _('Delete message') }}</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p class="mb-0">{{ _('Are you sure you want to delete this message?') }}</p>
      </div>
      <div class="modal-footer border-0">
        <button type="button" class="btn btn-outline-light" data-bs-dismiss="modal">{{ _('Cancel') }}</button>
        <button type="button" class="btn btn-danger" id="confirm-delete-message">{{ _('Delete') }}</button>
      </div>
    </div>
  </div>
</div>

<!-- DM modal -->
<div class="modal fade" id="dmModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content bg-dark text-light">
      <div class="modal-header border-0">
        <h5 class="modal-title">{{ _('Start private chat') }}</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p class="text-muted">{{ _('Enter a shared secret for this private conversation. It will be used to derive your E2EE key.') }}</p>
        <input type="hidden" id="dm-user-id">
        <div class="mb-3">
          <label class="form-label">{{ _('Secret') }}</label>
          <div class="input-group">
            <input type="password" class="form-control" id="dm-secret" autocomplete="off" minlength="12">
            <button class="btn btn-outline-light" type="button" id="dm-secret-toggle" aria-label="{{ _('Show secret') }}"><i class="fa-solid fa-eye"></i></button>
            <button class="btn btn-outline-light" type="button" id="dm-secret-gen" aria-label="{{ _('Generate secret') }}"><i class="fa-solid fa-wand-magic-sparkles"></i></button>
            <button class="btn btn-outline-light" type="button" id="dm-secret-copy" aria-label="{{ _('Copy secret') }}"><i class="fa-solid fa-copy"></i></button>
          </div>
          <div class="form-text text-muted">{{ _('Minimum 12 characters.') }}</div>
        </div>
      </div>
      <div class="modal-footer border-0">
        <button type="button" class="btn btn-outline-light" data-bs-dismiss="modal">{{ _('Cancel') }}</button>
        <button type="button" class="btn btn-soft" id="dm-start-btn">{{ _('Start') }}</button>
      </div>
    </div>
  </div>
</div>

<!-- Media modal -->
<div class="modal fade" id="mediaModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content bg-dark text-light position-relative">
      <div class="modal-header border-0 pb-0">
        <h5 class="modal-title">Media preview</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body text-center" id="mediaModalBody"></div>
    </div>
  </div>
</div>

<!-- Info modal -->
<div class="modal fade" id="infoModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content bg-dark text-light">
      <div class="modal-header border-0">
        <h5 class="modal-title" id="infoModalTitle">Notice</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="infoModalBody"></div>
      <div class="modal-footer border-0">
        <button type="button" class="btn btn-soft" data-bs-dismiss="modal">OK</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="{{ url_for('static', filename='js/chat.js', v=config.APP_VERSION) }}"></script>
{% include 'modals/scheduled_delete.html' %}
<script>
  (() => {
    const sidebar = document.getElementById('groupSidebar');
    if (!sidebar || typeof bootstrap === 'undefined') return;
    let userToggled = false;
    const toggleBtns = document.querySelectorAll('[data-bs-target=\"#groupSidebar\"]');
    toggleBtns.forEach((btn) => {
      btn.addEventListener('click', () => { userToggled = true; });
    });
    const syncSidebar = () => {
      const isDesktop = window.matchMedia('(min-width: 992px)').matches;
      const inst = bootstrap.Collapse.getOrCreateInstance(sidebar, { toggle: false });
      if (isDesktop && !userToggled) {
        inst.show();
      }
      if (!isDesktop) {
        inst.hide();
        userToggled = false;
      }
    };
    window.addEventListener('resize', syncSidebar);
    syncSidebar();
  })();
</script>
<script>
  (() => {
    const form = document.getElementById('create-group-form');
    const modalEl = document.getElementById('createGroupModal');
    if (!form || !modalEl || typeof bootstrap === 'undefined') return;
    const submitBtn = document.getElementById('create-group-submit');
    const errorEl = document.getElementById('create-group-error');
    const qrModalEl = document.getElementById('groupCreatedModal');
    const qrImg = document.getElementById('group-created-qr');
    const qrTitle = document.getElementById('groupCreatedModalLabel');
    const qrHint = document.getElementById('group-created-hint');
    const genBtn = document.getElementById('create-gen-secret');
    const copyBtn = document.getElementById('create-copy-secret');
    const secretInput = document.getElementById('create-group-secret');
    const modalInstance = bootstrap.Modal.getOrCreateInstance(modalEl);
    const qrModalInstance = bootstrap.Modal.getOrCreateInstance(qrModalEl);

    const randomSecret = (len = 24) => {
      const chars = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*()-_=+';
      let out = '';
      const arr = crypto.getRandomValues(new Uint32Array(len));
      for (let i = 0; i < len; i += 1) {
        out += chars[arr[i] % chars.length];
      }
      return out;
    };

    const copySecretValue = async (value) => {
      if (!value) return false;
      try {
        if (navigator?.clipboard?.writeText) {
          await navigator.clipboard.writeText(value);
          return true;
        }
      } catch (err) {
        // fall through to legacy path
      }
      try {
        const textarea = document.createElement('textarea');
        textarea.value = value;
        textarea.setAttribute('readonly', '');
        textarea.style.position = 'fixed';
        textarea.style.top = '-1000px';
        textarea.setAttribute('aria-hidden', 'true');
        document.body.appendChild(textarea);
        textarea.select();
        textarea.setSelectionRange(0, textarea.value.length);
        const succeeded = document.execCommand('copy');
        document.body.removeChild(textarea);
        return succeeded;
      } catch (err) {
        return false;
      }
    };

    const showError = (message) => {
      if (!errorEl) return;
      errorEl.textContent = message;
      errorEl.classList.remove('d-none');
    };

    form.addEventListener('submit', async (event) => {
      event.preventDefault();
      if (submitBtn) submitBtn.disabled = true;
      if (errorEl) errorEl.classList.add('d-none');
      try {
        const response = await fetch(form.action, {
          method: form.method || 'POST',
          headers: { 'X-Requested-With': 'XMLHttpRequest' },
          body: new FormData(form),
        });
        let payload;
        try {
          payload = await response.json();
        } catch (err) {
          payload = null;
        }
        if (!response.ok || !payload?.ok) {
          const errors = payload?.errors;
          const details = errors ? Object.values(errors).flat().join(' ') : payload?.message;
          showError(details || "{{ _('Unable to create group at the moment.') }}");
          return;
        }
        modalInstance.hide();
        if (payload?.group?.name) {
          qrTitle.textContent = `${payload.group.name} {{ _('created') }}`;
        }
        if (qrHint) {
          qrHint.textContent = payload?.message || "{{ _('Share this QR offline with trusted members. The server only stores a salted hash of the secret.') }}";
        }
        if (qrImg && payload?.qr_data) {
          qrImg.src = payload.qr_data;
        }
        qrModalInstance.show();
        form.reset();
        if (window.showToast) {
          window.showToast('success', payload?.message || "{{ _('Group created') }}");
        }
        if (typeof fetchGroups === 'function') {
          fetchGroups().catch(() => {});
        }
      } catch (err) {
        console.error('create group modal failed', err);
        showError("{{ _('Unable to reach the server. Try again shortly.') }}");
      } finally {
        if (submitBtn) submitBtn.disabled = false;
      }
    });

    genBtn?.addEventListener('click', () => {
      if (secretInput) {
        secretInput.value = randomSecret();
      }
    });

    copyBtn?.addEventListener('click', async () => {
      const ok = await copySecretValue(secretInput?.value || '');
      try {
        window.showToast?.(
          ok ? 'success' : 'error',
          ok ? "{{ _('Copied') }}" : "{{ _('Copy failed') }}",
          ok ? "{{ _('Secret copied to clipboard.') }}" : "{{ _('Clipboard is blocked in this browser.') }}"
        );
      } catch (err) {
        // ignore toast errors
      }
    });
  })();
</script>
{% endblock %}
