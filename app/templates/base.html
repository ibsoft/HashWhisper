<!doctype html>
<html lang="{{ get_locale() or 'en' }}" data-bs-theme="dark">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="csrf-token" content="{{ csrf_token() }}">
  <meta name="theme-color" content="#0a0f1c">
  <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">
  <link rel="icon" href="{{ url_for('static', filename='img/icon.svg') }}">
  <title>{{ config.APP_TITLE }}</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css', v=config.APP_VERSION) }}">
  {% set flash_messages = get_flashed_messages(with_categories=true) %}
  <script>
    window.APP_TITLE = "{{ config.APP_TITLE }}";
    window.FLASH_MESSAGES = {{ flash_messages|tojson|safe }};
  </script>
</head>
<body class="bg-gradient">
<div class="flash-fallback" data-flash-fallback>
  {% for category, msg in flash_messages %}
    <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show m-3 shadow-sm" role="alert">
      {{ msg }}
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
  {% endfor %}
</div>
<nav class="navbar navbar-dark navbar-glass sticky-top fancy-nav">
  <div class="container-fluid fancy-bar py-2">
    <div class="d-flex align-items-center gap-3 flex-shrink-0">
      <a class="navbar-brand fw-bold d-flex align-items-center gap-1 flex-shrink-0" href="{{ url_for('chat.chat') }}">
        <img src="{{ url_for('static', filename='img/logo.png') }}" alt="Logo" width="32" height="32" class="d-inline-block align-text-top nav-logo">
      </a>
    </div>
    <div class="nav-inline-scroll d-flex align-items-center gap-2 flex-nowrap ms-auto">
      {% if current_user.is_authenticated %}
      <span class="chip chip-secure flex-shrink-0 nav-token" title="{{ _('AES-GCM encryption') }}"><i class="fa-solid fa-shield-halved"></i> AES-GCM</span>
      <span class="chip chip-user flex-shrink-0 nav-token chip-tight d-flex align-items-center gap-2">
        <span class="dot-pulse" aria-label="{{ _('Online') }}" title="{{ _('Online') }}"></span>
        {{ current_user.username }}
      </span>
      <a class="btn btn-sm btn-ghost flex-shrink-0 nav-token nav-chip" href="{{ url_for('settings.settings') }}"><i class="fa-solid fa-gear"></i> <span class="d-none d-sm-inline">{{ _('Settings') }}</span></a>
      <a class="btn btn-sm btn-ghost flex-shrink-0 nav-token nav-chip nav-chip-warn" href="{{ url_for('auth.logout') }}" data-logout><i class="fa-solid fa-right-from-bracket"></i> <span class="d-none d-sm-inline">{{ _('Logout') }}</span></a>
      {% endif %}
    </div>
  </div>
</nav>
<main class="py-4">
  <div class="container-fluid px-3 px-md-4">
    {% block content %}{% endblock %}
  </div>
</main>
<footer class="text-center py-3 text-muted small">
  <div>
    {{ _('Built by IBSoft') }} • <a href="https://github.com/ibsoft/HashWhisper" target="_blank" rel="noopener" class="text-decoration-none text-muted"><i class="fa-brands fa-github"></i> GitHub</a>
    • {{ _('Version') }} {{ config.APP_VERSION }}
  </div>
</footer>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script>
  (() => {
    const userPref = "{{ current_user.preferred_theme if current_user.is_authenticated else 'dark' }}";
    const saved = localStorage.getItem('hw-theme');
    let theme = saved || userPref || 'dark';
    if (theme === 'system') {
      theme = window.matchMedia('(prefers-color-scheme: light)').matches ? 'light' : 'dark';
    }
    document.documentElement.setAttribute('data-bs-theme', theme);
    localStorage.setItem('hw-theme', theme);
  })();
  (() => {
    const serverLang = "{{ current_user.language if current_user.is_authenticated else '' }}";
    const saved = localStorage.getItem('hw-lang');
    if (serverLang && serverLang !== saved) {
      localStorage.setItem('hw-lang', serverLang);
    }
    const desired = localStorage.getItem('hw-lang');
    const url = new URL(window.location.href);
    const paramLang = url.searchParams.get('lang');
    // Avoid loops: only redirect if param missing and we have a stored lang
    if (!paramLang && desired) {
      url.searchParams.set('lang', desired);
      window.location.replace(url.toString());
    }
  })();
  (() => {
    const hasToastr = Boolean(window.toastr);
    if (hasToastr) {
      toastr.options = {
        closeButton: true,
        newestOnTop: true,
        positionClass: 'toast-top-right',
        timeOut: 8000,
        extendedTimeOut: 4000,
        progressBar: true,
      };
    }
    const showModal = (title, message) => {
      const modalEl = document.getElementById('infoModal');
      const modalTitle = document.getElementById('infoModalTitle');
      const modalBody = document.getElementById('infoModalBody');
      if (modalEl && modalTitle && modalBody && window.bootstrap?.Modal) {
        modalTitle.textContent = title || window.APP_TITLE || 'Notice';
        modalBody.textContent = message || '';
        window.bootstrap.Modal.getOrCreateInstance(modalEl).show();
        return true;
      }
      return false;
    };
    const fallbackToast = (type = 'info', title = '', message = '') => {
      const text = title ? `${title}: ${message}` : message;
      if (type === 'error') alert(text);
      else console.log(text);
    };
    window.showToast =
      window.showToast ||
      ((type = 'info', title = '', message = '', options = {}) => {
        try {
          if (hasToastr) {
            const fn = toastr[type] || toastr.info;
            fn.call(toastr, message || '', title || '', options || {});
            if (options.forceModal) showModal(title, message);
            return;
          }
        } catch (err) {
          // fall through
        }
        if (options.forceModal && showModal(title, message)) return;
        fallbackToast(type, title, message);
      });
    if (Array.isArray(window.FLASH_MESSAGES)) {
      window.FLASH_MESSAGES.forEach(([category, msg]) => {
        const map = { danger: 'error', warning: 'warning', info: 'info', success: 'success' };
        const t = map[category] || 'info';
        const text = (msg || '').toLowerCase();
        const isGroupNameConflict =
          text.includes('group with this name') ||
          text.includes('υπάρχει ήδη ομάδα με αυτό το όνομα');
        const opts = isGroupNameConflict
          ? { timeOut: 20000, extendedTimeOut: 8000, forceModal: true }
          : undefined;
        window.showToast(t, window.APP_TITLE || 'Notice', msg, opts);
      });
    }
    document.querySelectorAll('[data-flash-fallback]').forEach((node) => node.remove());
  })();
</script>
<script src="{{ url_for('static', filename='js/main.js', v=config.APP_VERSION) }}"></script>
{% block scripts %}{% endblock %}
</body>
</html>
